# 1. 概述

本文档详细说明了RBAC（基于角色的访问控制）系统中角色管理的业务逻辑，重点关注角色继承关系的稳定性和数据完整性保护。

## 1.1 设计原则

1. **继承关系稳定性**：角色继承关系应该是稳定的，避免频繁变更导致权限混乱
2. **数据完整性保护**：防止删除仍在使用的角色，确保系统数据的完整性
3. **层次化设计/验证**：在操作前进行多层次的业务逻辑验证
4. **最小权限原则**：确保用户只能操作自己有权限的角色
5. **单一职责原则**：每个角色有明确的职责范围
6. **组织隔离**: 不同组织的角色相互独立

## 1.2 权限层次
- **超级管理员**：可以管理所有角色
- **组织管理员**：可以管理组织下所有角色
- **角色创建者**：可以管理自己创建的角色
- **角色拥有者**：无角色管理权限

## 1.3. 权限检查
- 超级管理员特权检查
- 组织管理员特权检查
- 资源创建者检查
- 权限点检查
- 可选的资源范围检查（暂不考虑实现）

# 2. 业务逻辑

## 2.1 角色创建
- **权限校验**: 当前操作者是否有创建权限
- **业务逻辑检查**
    - 父角色验证：如果指定了父角色，父角色必须存在  
    - 组织一致性：父子角色必须属于同一组织
    - 验证角色层次关系: 防止循环引用
- **权限过滤**：只能分配操作者权限的子集
- **记录日志**

## 2.2 删除规则
- **权限校验**
    - 当前操作者是否有删除权限
- **业务逻辑检查** 
    - 检查后代角色（直接后代、间接后代）是否全部在删除列表中？
        - 否 -> 不允许删除
        - 是 -> 继续检查
    - 检查待删除角色是否关联用户？
        - 是 -> 不允许删除
        - 否 -> 允许删除
- **记录日志**

## 2.3 编辑规则
- **权限校验**: 当前操作者是否有编辑权限
- **业务逻辑检查**
    - 父角色验证：如果指定了父角色，父角色必须存在  
    - 组织一致性：父子角色必须属于同一组织
    - 验证角色层次关系: 防止循环引用
- **权限过滤**：只能分配操作者权限的子集
- **记录日志**



## 3. 接口设计
- **角色创建**: `POST /api/v1/identify-service/roles`
- **角色删除**: `DELETE /api/v1/identify-service/roles/:id`
- **角色修改**: `PATCH /api/v1/identify-service/roles/:id`
- **角色详情**: `GET /api/v1/identify-service/roles/:id`
- **角色列表**: `GET /api/v1/identify-service/roles?org_id=xx`
- **角色树**: `GET /api/v1/identify-service/roles/:id/tree`
- **角色树列表**: `GET /api/v1/identify-service/roles/tree?org_id=xx`





