# 多组织架构权限设计策略

## 1. 权限层级架构

### 1.1 三层权限模型

```
┌─────────────────────────────────────────┐
│           组织级权限                    │
│  (组织所有者、组织管理员)               │
├─────────────────────────────────────────┤
│           功能级权限                    │
│  (角色管理、用户管理、资源管理)         │
├─────────────────────────────────────────┤
│           数据级权限                    │
│  (具体数据的增删改查权限)              │
└─────────────────────────────────────────┘
```

### 1.2 权限资源定义

```go
// 权限资源常量定义
const (
    // 组织级资源
    ResourceOrgManage     = "org:manage"      // 组织管理
    ResourceOrgView       = "org:view"        // 组织查看
    
    // 角色管理资源
    ResourceRoleCreate    = "role:create"     // 角色创建
    ResourceRoleEdit      = "role:edit"       // 角色编辑
    ResourceRoleDelete    = "role:delete"     // 角色删除
    ResourceRoleView      = "role:view"       // 角色查看
    ResourceRoleAssign    = "role:assign"     // 角色分配
    
    // 用户管理资源
    ResourceUserCreate    = "user:create"     // 用户创建
    ResourceUserEdit      = "user:edit"       // 用户编辑
    ResourceUserDelete    = "user:delete"     // 用户删除
    ResourceUserView      = "user:view"       // 用户查看
    
    // 资源管理
    ResourceResourceManage = "resource:manage" // 资源管理
    ResourceResourceView   = "resource:view"   // 资源查看
)
```

## 2. 角色创建权限设计

### 2.1 权限验证策略

```go
// 角色创建权限验证
func (s *role) validateRoleCreatePermission(ctx context.Context, req *system.RoleAddReq) error {
    currentUser := service.SQContext().GetLoginUser(ctx)
    
    // 1. 检查用户是否有组织管理权限
    if !s.hasOrgPermission(ctx, currentUser.ID, req.OrgID, ResourceOrgManage) {
        return errors.New("没有组织管理权限")
    }
    
    // 2. 检查用户是否有角色创建权限
    if !s.hasResourcePermission(ctx, currentUser.ID, ResourceRoleCreate) {
        return errors.New("没有角色创建权限")
    }
    
    // 3. 检查用户是否属于该组织
    if !s.userBelongsToOrg(ctx, currentUser.ID, req.OrgID) {
        return errors.New("不属于该组织")
    }
    
    // 4. 检查角色名称在同一组织下是否唯一
    if s.isRoleNameExists(ctx, req.OrgID, req.Name) {
        return errors.New("该组织下已存在同名角色")
    }
    
    return nil
}

// 组织权限检查
func (s *role) hasOrgPermission(ctx context.Context, userID string, orgID int64, resource string) bool {
    // 超级管理员拥有所有权限
    if service.User().IsSupperAdmin(ctx, userID) {
        return true
    }
    
    // 检查用户是否是组织所有者
    if s.isOrgOwner(ctx, userID, orgID) {
        return true
    }
    
    // 检查用户是否是组织管理员
    if s.isOrgAdmin(ctx, userID, orgID) {
        return true
    }
    
    // 检查用户是否有该资源的权限
    return s.hasResourcePermission(ctx, userID, resource)
}

// 资源权限检查
func (s *role) hasResourcePermission(ctx context.Context, userID string, resource string) bool {
    enforcer, err := service.CasbinEnforcer(ctx)
    if err != nil {
        g.Log().Error(ctx, err)
        return false
    }
    
    // 获取用户的所有角色
    roleIDs, err := service.User().GetUserRoleIDs(ctx, userID, false)
    if err != nil {
        g.Log().Error(ctx, err)
        return false
    }
    
    // 检查每个角色是否有该资源的权限
    for _, roleID := range roleIDs {
        hasPermission, _ := enforcer.Enforce(
            gconv.String(roleID),
            resource,
            "All"
        )
        if hasPermission {
            return true
        }
    }
    
    return false
}
```

### 2.2 组织角色定义

```go
// 组织角色常量
const (
    RoleOrgOwner    = "org_owner"    // 组织所有者
    RoleOrgAdmin    = "org_admin"    // 组织管理员
    RoleOrgUser     = "org_user"     // 组织普通用户
    RoleOrgGuest    = "org_guest"    // 组织访客
)

// 组织角色权限映射
var OrgRolePermissions = map[string][]string{
    RoleOrgOwner: {
        ResourceOrgManage,
        ResourceRoleCreate, ResourceRoleEdit, ResourceRoleDelete, ResourceRoleView, ResourceRoleAssign,
        ResourceUserCreate, ResourceUserEdit, ResourceUserDelete, ResourceUserView,
        ResourceResourceManage, ResourceResourceView,
    },
    RoleOrgAdmin: {
        ResourceRoleCreate, ResourceRoleEdit, ResourceRoleView, ResourceRoleAssign,
        ResourceUserCreate, ResourceUserEdit, ResourceUserView,
        ResourceResourceView,
    },
    RoleOrgUser: {
        ResourceRoleView,
        ResourceUserView,
        ResourceResourceView,
    },
    RoleOrgGuest: {
        ResourceResourceView,
    },
}
```

## 3. 权限初始化策略

### 3.1 组织创建时初始化权限

```go
// 创建组织时初始化权限
func (s *org) createOrgWithPermissions(ctx context.Context, req *system.OrgCreateReq) error {
    return g.DB().Transaction(ctx, func(ctx context.Context, tx gdb.TX) error {
        // 1. 创建组织
        orgID, err := dao.Org.Ctx(ctx).TX(tx).InsertAndGetId(map[string]interface{}{
            dao.Org.Columns().Name:     req.Name,
            dao.Org.Columns().Code:     req.Code,
            dao.Org.Columns().Status:   model.OrgStatusEnabled,
            dao.Org.Columns().CreatorID: req.CreatorID,
        })
        if err != nil {
            return fmt.Errorf("创建组织失败: %w", err)
        }
        
        // 2. 创建组织默认角色
        err = s.createDefaultOrgRoles(ctx, tx, orgID)
        if err != nil {
            return fmt.Errorf("创建默认角色失败: %w", err)
        }
        
        // 3. 为创建者分配组织所有者角色
        err = s.assignOrgOwnerRole(ctx, tx, orgID, req.CreatorID)
        if err != nil {
            return fmt.Errorf("分配所有者角色失败: %w", err)
        }
        
        return nil
    })
}

// 创建组织默认角色
func (s *org) createDefaultOrgRoles(ctx context.Context, tx gdb.TX, orgID int64) error {
    enforcer, err := service.CasbinEnforcer(ctx)
    if err != nil {
        return err
    }
    
    // 为每个组织角色创建权限策略
    for roleName, permissions := range OrgRolePermissions {
        // 创建角色记录
        roleID, err := dao.Role.Ctx(ctx).TX(tx).InsertAndGetId(map[string]interface{}{
            dao.Role.Columns().OrgID:    orgID,
            dao.Role.Columns().Name:     roleName,
            dao.Role.Columns().Status:   model.RoleStatusEnabled,
            dao.Role.Columns().CreatorID: "system",
        })
        if err != nil {
            return err
        }
        
        // 为角色分配权限
        for _, permission := range permissions {
            _, err = enforcer.AddNamedPolicy("p", []string{
                gconv.String(roleID),
                permission,
                "All",
            })
            if err != nil {
                return err
            }
        }
    }
    
    return nil
}
```

## 4. 权限验证中间件

### 4.1 组织权限中间件

```go
// 组织权限中间件
func OrgPermissionMiddleware(orgIDField string, resource string) gin.HandlerFunc {
    return func(c *gin.Context) {
        ctx := c.Request.Context()
        
        // 获取组织ID
        orgIDStr := c.Param(orgIDField)
        if orgIDStr == "" {
            orgIDStr = c.Query(orgIDField)
        }
        if orgIDStr == "" {
            c.JSON(400, gin.H{"error": "组织ID不能为空"})
            c.Abort()
            return
        }
        
        orgID := gconv.Int64(orgIDStr)
        userID := service.SQContext().GetUserId(ctx)
        
        // 检查组织权限
        if !hasOrgPermission(ctx, userID, orgID, resource) {
            c.JSON(403, gin.H{"error": "没有权限访问该组织"})
            c.Abort()
            return
        }
        
        c.Next()
    }
}

// 资源权限中间件
func ResourcePermissionMiddleware(resource string) gin.HandlerFunc {
    return func(c *gin.Context) {
        ctx := c.Request.Context()
        userID := service.SQContext().GetUserId(ctx)
        
        // 检查资源权限
        if !hasResourcePermission(ctx, userID, resource) {
            c.JSON(403, gin.H{"error": "没有权限访问该资源"})
            c.Abort()
            return
        }
        
        c.Next()
    }
}
```

## 5. API接口权限设计

### 5.1 角色管理API权限

```go
// 角色管理路由权限配置
func setupRoleRoutes(r *gin.RouterGroup) {
    roleGroup := r.Group("/role")
    {
        // 角色创建 - 需要组织管理权限 + 角色创建权限
        roleGroup.POST("/:org_id", 
            OrgPermissionMiddleware("org_id", ResourceOrgManage),
            ResourcePermissionMiddleware(ResourceRoleCreate),
            roleController.Create)
        
        // 角色编辑 - 需要组织管理权限 + 角色编辑权限
        roleGroup.PUT("/:org_id/:id", 
            OrgPermissionMiddleware("org_id", ResourceOrgManage),
            ResourcePermissionMiddleware(ResourceRoleEdit),
            roleController.Edit)
        
        // 角色删除 - 需要组织管理权限 + 角色删除权限
        roleGroup.DELETE("/:org_id/:id", 
            OrgPermissionMiddleware("org_id", ResourceOrgManage),
            ResourcePermissionMiddleware(ResourceRoleDelete),
            roleController.Delete)
        
        // 角色查看 - 需要组织查看权限 + 角色查看权限
        roleGroup.GET("/:org_id", 
            OrgPermissionMiddleware("org_id", ResourceOrgView),
            ResourcePermissionMiddleware(ResourceRoleView),
            roleController.List)
    }
}
```

## 6. 权限检查工具函数

### 6.1 权限检查工具

```go
// 权限检查工具
type PermissionChecker struct{}

// 检查组织权限
func (pc *PermissionChecker) CheckOrgPermission(ctx context.Context, userID string, orgID int64, resource string) bool {
    // 超级管理员拥有所有权限
    if service.User().IsSupperAdmin(ctx, userID) {
        return true
    }
    
    // 检查用户是否属于该组织
    if !pc.userBelongsToOrg(ctx, userID, orgID) {
        return false
    }
    
    // 检查用户是否有该资源的权限
    return pc.hasResourcePermission(ctx, userID, resource)
}

// 检查跨组织权限
func (pc *PermissionChecker) CheckCrossOrgPermission(ctx context.Context, userID string, sourceOrgID, targetOrgID int64, resource string) bool {
    // 检查源组织权限
    if !pc.CheckOrgPermission(ctx, userID, sourceOrgID, resource) {
        return false
    }
    
    // 检查目标组织权限
    if !pc.CheckOrgPermission(ctx, userID, targetOrgID, resource) {
        return false
    }
    
    return true
}

// 检查数据权限
func (pc *PermissionChecker) CheckDataPermission(ctx context.Context, userID string, dataOrgID int64, resource string) bool {
    return pc.CheckOrgPermission(ctx, userID, dataOrgID, resource)
}
```

## 7. 权限审计日志

### 7.1 权限操作日志

```go
// 权限操作日志
type PermissionLog struct {
    ID         int64       `json:"id"`
    UserID     string      `json:"user_id"`
    OrgID      int64       `json:"org_id"`
    Resource   string      `json:"resource"`
    Action     string      `json:"action"`
    Result     bool        `json:"result"`
    IP         string      `json:"ip"`
    UserAgent  string      `json:"user_agent"`
    CreatedAt  *gtime.Time `json:"created_at"`
}

// 记录权限检查日志
func logPermissionCheck(ctx context.Context, userID string, orgID int64, resource string, action string, result bool) {
    log := &PermissionLog{
        UserID:    userID,
        OrgID:     orgID,
        Resource:  resource,
        Action:    action,
        Result:    result,
        IP:        service.SQContext().GetClientIP(ctx),
        UserAgent: service.SQContext().GetUserAgent(ctx),
        CreatedAt: gtime.Now(),
    }
    
    // 异步记录日志
    go func() {
        dao.PermissionLog.Ctx(ctx).Insert(log)
    }()
}
```

## 8. 最佳实践

### 8.1 权限设计原则

1. **最小权限原则**：只给用户分配必要的权限
2. **职责分离**：不同角色承担不同职责
3. **权限继承**：子组织可以继承父组织权限
4. **权限审计**：记录所有权限操作日志

### 8.2 性能优化

1. **权限缓存**：缓存用户权限信息
2. **批量检查**：批量检查多个权限
3. **索引优化**：为权限相关字段添加索引

### 8.3 安全考虑

1. **权限验证**：在每个关键操作前验证权限
2. **数据隔离**：确保不同组织数据完全隔离
3. **权限边界**：明确各组织的权限边界 