# CloundPhone


## Done List
- 文件上传
  - 个人头像
- 账户注册
  - 手机号+验证码
- 账户注销
- 账户登录
  - 手机号+验证码
  - 手机号+密码
- 个人信息管理
  - 获取个人信息
  - 个人信息编辑
    - 头像
    - 昵称
    - 性别
    - 生日
    - 地区    
- 绑定手机号
  - 验证码发送、校验
- 换绑手机号
  - 验证码发送、校验  
- 修改密码
  - 验证码发送/校验
  - 重置新密码
- 个人实名认证
  - 身份证号
  - 加密、脱敏

## TODO List
- 修改密码后
  - 应该清除之前的访问令牌
  - 并发送WebSocket消息，强制退出。


## 登录设备管理
- 登录时，记录设备相关信息
  - 仅client_type为android、ios时记录，web不记录
  - 如果不存在设备记录，则插入。
  - 如果已经存在设备记录，则更新、
- 提供接口，查询用户历史登录设备记录。
- 提供接口，根据设备ID删除历史登录记录。

### 登录接口
- 客户端类型
- 服务协议

### 部门账户管理
- 新增部门用户
- 部门用户列表
- 权限控制



## Done List
- 实现登录接口: 手机号+密码、手机号+验证码、SSO+ticket
    - 验证码生成、发送、验证
    - SSO接口对接
- 实现令牌内省接口

## TODO List
- 角色体系设计(登录平台后，选择入住服务类型)
    - 服务提供商
    - 商户
- 权限
    - 组织：一个服务提供商就是一个组织

## 业务描述
- Web管理后台，需要满足以下不同类型账户的使用: 通过RBAC来实现
    - 平台管理方
        - 管理游戏模块
        - 管理展会模块
    - 展会-服务提供商
    - 展会-展商

## 登录逻辑
- 四种登录方式
  - 手机号+密码
    - login_type = 1
    - 如果是未注册用户，提示其只能通过手机验证码登录。
    - 如果是已注册用户，但没设置密码，提示其只能通过手机验证码登录。
    - 如果是已注册用户，验证其手机号、密码是否匹配。
  - 手机号+验证码
    - login_type = 2
    - 如果是未注册用户，自动注册。
    - 如果是已注册用户，验证手机验证码是否正确。
  - IUQU账户一键登录(仅供移动端使用)
    - login_type = 3
    - SSO接口完成后，自动注册用户。
  - 账户名+密码登录
    - 仅在本平台验证。

- 登录平台后，检测当前帐户是否已经入驻
  - 如果已经入驻，跳转到对应的工作台页面。
  - 如果没有入驻完成
    - 没有填写申请信息，跳转到入驻申请页面
    - 已经申请，但是还在审核中，显示审核进度
```mermaid
flowchart TD
    A[开始] --> B[选择登录方式]
    B -->|login_type=1| C1[密码登录]
    B -->|login_type=2| C2[验证码登录]
    B -->|login_type=3| C3[SSO一键登录]
    
    %% 密码登录流程
    C1 --> D1[输入手机号+密码]
    D1 --> E1{用户是否注册?}
    E1 -->|未注册| F1[提示：请使用验证码登录]
    E1 -->|已注册| G1{是否设置密码?}
    G1 -->|未设置| F1
    G1 -->|已设置| H1[验证密码]
    H1 --> I1{验证成功?}
    I1 -->|是| J[登录成功]
    I1 -->|否| D1
    
    %% 验证码登录流程
    C2 --> D2[输入手机号+验证码]
    D2 --> E2{用户是否注册?}
    E2 -->|未注册| F2[自动注册新账号]
    E2 -->|已注册| G2[验证验证码]
    F2 --> G2
    G2 --> H2{验证成功?}
    H2 -->|是| J
    H2 -->|否| D2
    
    %% SSO登录流程
    C3 --> D3[调用SSO接口验证ticket]
    D3 --> E3{验证成功?}
    E3 -->|否| C3
    E3 -->|是| F3{SSO账号是否关联平台账号?}
    F3 -->|是| J
    F3 -->|否| G3[输入手机号]
    G3 --> H3{手机号是否已注册?}
    H3 -->|是| I3[提示：手机号已被使用]
    I3 -->|更换手机号| G3
    H3 -->|否| J3[创建账号并关联SSO]
    J3 --> J
    
    %% 登录后处理
    J --> K{是否已入驻?}
    K -->|是| L[跳转到工作台]
    K -->|否| M{是否提交过申请?}
    M -->|否| N[跳转入驻申请页面]
    M -->|是| O{审核状态}
    O -->|审核中| P[显示审核进度]
    O -->|审核失败| Q[跳转重新申请页面]
    O -->|审核通过| L
```